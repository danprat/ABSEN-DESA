# Backend API

## Package Identity
FastAPI backend for attendance system with face recognition, JWT auth, and MySQL database. Handles all business logic, authentication, and ML-powered face matching.

## Setup & Run
```bash
# From backend/ directory
python -m venv venv
source venv/bin/activate  # Mac/Linux: venv/bin/activate, Windows: venv\Scripts\activate
pip install -r requirements.txt

# Setup database
cp .env.example .env  # Edit with your DATABASE_URL, SECRET_KEY
alembic upgrade head

# Run development server
uvicorn app.main:app --reload --port 8000

# Create migration after model changes
alembic revision --autogenerate -m "description"
alembic upgrade head
```

## Patterns & Conventions

### File Organization
- **Models**: `app/models/*.py` - SQLAlchemy ORM models, one per table
- **Schemas**: `app/schemas/*.py` - Pydantic request/response schemas
- **Routers**: `app/routers/*.py` - FastAPI route handlers
- **Services**: `app/services/*.py` - Business logic layer
- **Utils**: `app/utils/*.py` - Helpers (auth, audit logging)

### Code Patterns
- **DO**: Follow router → schema → model → service pattern
  - Example: `app/routers/employees.py` → `app/schemas/employee.py` → `app/models/employee.py` → services layer
- **DO**: Use dependency injection for auth
  - Example: `current_user: User = Depends(get_current_user)` in `app/routers/employees.py:15`
- **DO**: Use Pydantic schemas for validation
  - Request schemas in `app/schemas/`, see `app/schemas/employee.py:10-20`
- **DON'T**: Put business logic in routers, use service layer
- **DON'T**: Direct database access in routers, use SQLAlchemy models

### API Structure
All endpoints prefixed with `/api/v1` (configured in `app/main.py:33`)
```python
# Example router pattern
from fastapi import APIRouter, Depends
router = APIRouter(tags=["employees"], prefix="/employees")

@router.get("/", response_model=list[EmployeeResponse])
async def list_employees(db: Session = Depends(get_db)):
    # Implementation
```

### Authentication
- JWT tokens generated in `app/utils/auth.py:15-30`
- Protected routes use `Depends(get_current_user)` from `app/utils/auth.py:45`
- Admin routes use `Depends(get_current_admin_user)` from `app/utils/auth.py:60`

### Database Models
- All models inherit from `Base` in `app/database.py:10`
- Use SQLAlchemy 2.0 style (no legacy query API)
- Example: `app/models/employee.py` shows standard pattern
- Relationships: Use `relationship()` with back_populates

### Face Recognition
- Service layer in `app/services/face_recognition.py`
- Embeddings stored in `app/models/face_embedding.py`
- Face detection using dlib + face_recognition library
- Upload handling in `app/routers/face.py`

### Audit Logging
- All admin actions logged via `app/utils/audit.py`
- Log types defined in `app/models/audit_log.py:15-25`
- Usage: Import `log_admin_action` decorator

## Key Files
- **Main app**: `app/main.py` - FastAPI app setup, CORS, router registration
- **Database**: `app/database.py` - SQLAlchemy engine, session factory
- **Config**: `app/config.py` - Environment variables, settings
- **Auth utils**: `app/utils/auth.py` - JWT creation, user dependencies
- **Migrations**: `alembic/versions/*.py` - Database schema versions

## JIT Index Hints
```bash
# Find endpoint by path
rg -n "@router\.(get|post|put|delete)\(.*employees" app/routers/

# Find model by name
rg -n "class Employee\(" app/models/

# Find schema by name
rg -n "class EmployeeCreate\(" app/schemas/

# Find service function
rg -n "def \w+.*face" app/services/

# Find all admin-protected routes
rg -n "get_current_admin_user" app/routers/

# Find audit log usage
rg -n "log_admin_action" app/
```

## Database Schema
```bash
# View current schema version
alembic current

# View migration history
alembic history

# Downgrade one version
alembic downgrade -1

# SQL preview without applying
alembic upgrade head --sql
```

## Common Gotchas
- **Face recognition dependencies**: Requires dlib (needs C++ compiler on install)
- **Image uploads**: Saved to `uploads/faces/`, ensure directory exists (created in `app/main.py:30`)
- **CORS**: Frontend origin must be in `CORS_ORIGINS` env var (comma-separated)
- **Migrations**: ALWAYS review autogenerated migrations before applying
- **Timezone**: All timestamps stored in UTC, convert in frontend

## API Documentation
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`
- OpenAPI JSON: `http://localhost:8000/openapi.json`

## Pre-PR Checks
```bash
# From backend/ directory with venv activated
python -m pytest  # If tests exist
alembic check  # Verify migrations
uvicorn app.main:app --reload  # Ensure server starts without errors
```

## Environment Variables
Required in `.env`:
```bash
DATABASE_URL=mysql+pymysql://user:password@localhost/absen_desa
SECRET_KEY=your-secret-key-min-32-chars
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
CORS_ORIGINS=http://localhost:8080,http://localhost:3000
DEBUG=True
```
